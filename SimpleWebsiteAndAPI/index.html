<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>My First Website</title>
    
    <link rel="import" href="includes/head.html">
</head>
<body>
    
    <div style="margin:32px auto 0px auto;text-align: center;">

        <div id="rent"></div>
        <div id="loadGames"></div>
        <div>
            <div id="manufacturerList" style="margin-top:16px;"></div>
            <div id="sortButtons" style="margin-top:16px;">

            </div>
            <div style="margin-top:16px;">
                <table class="table table-striped table-bordered" style="max-width:700px;margin:auto;">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Platform<br><select id='platformList' onchange='getGamesByPlatform(this.value)'></select></th>
                            <th>Genre<br><select id='genreList' onchange='getGamesByGenre(this.value)'></select></th>
                            <th>Publisher<br><select id='publisherList' onchange='getGamesByPublisher(this.value)'></select></th>
                            <th>
                                Popularity<br>
                                <select id='popularityList' onchange='getGamesByPopularity(this.value)'>
                                    <option value='null'></option>
                                    <option value='1'>Most Popular</option>
                                    <option value='0'>Least Popular</option>
                                </select>
                            </th>
                            <th>Vote!</th>
                            <th>Rent</th>
                        </tr>
                    </thead>
                    <tbody id="gameList"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Our javascript -->
    <script>
        //service("", "{}", function (response) { }, function (response) { });

        var selectedVendor = 0;

        // Load the tab options automatically
        $("#loadGames").ready(function () {
            var d = "";
            service("getAllConsoles", "{}",
                function (response) {
                    $.each(response, function (index, value) {
                        d += "<button id=\"btn" + value.manufacturer + "\" onClick=\"getGames(\'" + value.manufacturer + "\')\">" + value.manufacturer + "</button>";
                    });
                    $("#manufacturerList").html(d);
                }, function (response) {
                    alert("Error...");
                    console.log(response);
                });
        });

        // Load the sort options automatically
        $("#platformList").ready(function () {
            var d = "<option value='default'></option>";
            service("getAllPlatforms", "{}",
                function (response) {
                    $.each(response, function (index, value) {
                        d += "<option value=\"" + value.name + "\">" + value.name + "</option>";
                    });
                    $("#platformList").html(d);
                }, function (response) {
                    alert("Error...");
                    console.log(response);
                });
        });

        $("#genreList").ready(function () {
            var d = "<option value='default'></option>";
            service("getAllGenres", "{}",
                function (response) {
                    $.each(response, function (index, value) {
                        d += "<option value=\"" + value.name + "\">" + value.name + "</option>";
                    });
                    $("#genreList").html(d);
                }, function (response) {
                    alert("Error...");
                    console.log(response);
                });
        });

        $("#publisherList").ready(function () {
            var d = "<option value='default'></option>";
            service("getAllPublishers", "{}",
                function (response) {
                    $.each(response, function (index, value) {
                        d += "<option value=\"" + value.publisher + "\">" + value.publisher + "</option>";
                    });
                    $("#publisherList").html(d);
                }, function (response) {
                    alert("Error...");
                    console.log(response);
                });
        });

        $("#platformList").change(function () {
            $("#genreList").val("default");
            $("#publisherList").val("default");
            $("#popularityList").val("null");
        });

        $("#genreList").change(function () {
            $("#platformList").val("default");
            $("#publisherList").val("default");
            $("#popularityList").val("null");
        });

        $("#publisherList").change(function () {
            $("#platformList").val("default");
            $("#genreList").val("default");
            $("#popularityList").val("null");
        });

        $("#popularityList").change(function () {
            $("#platformList").val("default");
            $("#genreList").val("default");
            $("#publisherList").val("default");
        });

        // Load the games for the first tab automatically
        $("#btnMicrosoft").ready(getGames("Microsoft"));
                

    function getGames(manufacturer) {
        console.log(manufacturer)
        var d = "";
            service("getByConsoleManufacturer", "{m:" + "\'" + manufacturer + "\'" + "}",
                function (response) {
                    $.each(response, function (index, value) {
                        cleansedTitle = value.gameName.replace(/ /g, "_").replace(/:/g, "").replace(/#/g, "").replace(/'/g, "");
                        d += "<tr>" +
                            "<td id=\"gameName\">" + value.gameName + "</td>" +
                            "<td>" + value.consoleName + "</td>" +
                            "<td>" + value.genreName + "</td>" +
                            "<td>" + value.publisher + "</td>" +
                            "<td id=\"btn" + cleansedTitle + "Pop\">" + value.popularity + "</td>" +
                            "<td><button id=\"btn" + cleansedTitle + "\" onClick=\"vote(\'" + value.gameName.replace(/'/g, "\\'") + "\', \'" + cleansedTitle + "\')\">I want to play this.</button>" + "</td>" +
                            "<td><button id=\"btn" + cleansedTitle + "\" onClick=\"rentalForm(\'" + value.gameName.replace(/'/g, "\\'") + "\')\">Rent</button>" + "</td>" +
                            "</tr>";
                    });
                    $("#gameList").html(d);
                }, function (response) {
                    alert("Error...");
                    console.log(response);
                });
        }

        function getGamesByPlatform(platform) {
            console.log(platform);
            var d = "";
            service("getByPlatform", "{p:" + "\'" + platform + "\'" + "}",
                function (response) {
                    $.each(response, function (index, value) {
                        cleansedTitle = value.gameName.replace(/ /g, "_").replace(/:/g, "").replace(/#/g, "").replace(/'/g, "");
                        d += "<tr>" +
                            "<td id=\"gameName\">" + value.gameName + "</td>" +
                            "<td>" + value.consoleName + "</td>" +
                            "<td>" + value.genreName + "</td>" +
                            "<td>" + value.publisher + "</td>" +
                            "<td id=\"btn" + cleansedTitle + "Pop\">" + value.popularity + "</td>" +
                            "<td><button id=\"btn" + cleansedTitle + "\" onClick=\"vote(\'" + value.gameName.replace(/'/g, "\\'") + "\', \'" + cleansedTitle + "\')\">I want to play this.</button>" + "</td>" +
                            "<td><button id=\"btn" + cleansedTitle + "\" onClick=\"rentalForm(\'" + value.gameName.replace(/'/g, "\\'") + "\')\">Rent</button>" + "</td>" +
                            "</tr>";
                    });
                    $("#gameList").html(d);
                }, function (response) {
                    alert("Error...");
                    console.log(response);
                });
        }

        function getGamesByGenre(genre) {
            var d = "";
            service("getByGenre", "{g:" + "\'" + genre + "\'" + "}",
                function (response) {
                    $.each(response, function (index, value) {
                        cleansedTitle = value.gameName.replace(/ /g, "_").replace(/:/g, "").replace(/#/g, "").replace(/'/g, "");
                        d += "<tr>" +
                            "<td id=\"gameName\">" + value.gameName + "</td>" +
                            "<td>" + value.consoleName + "</td>" +
                            "<td>" + value.genreName + "</td>" +
                            "<td>" + value.publisher + "</td>" +
                            "<td id=\"btn" + cleansedTitle + "Pop\">" + value.popularity + "</td>" +
                            "<td><button id=\"btn" + cleansedTitle + "\" onClick=\"vote(\'" + value.gameName.replace(/'/g, "\\'") + "\', \'" + cleansedTitle + "\')\">I want to play this.</button>" + "</td>" +
                            "<td><button id=\"btn" + cleansedTitle + "\" onClick=\"rentalForm(\'" + value.gameName.replace(/'/g, "\\'") + "\')\">Rent</button>" + "</td>" +
                            "</tr>";
                    });
                    $("#gameList").html(d);
                }, function (response) {
                    alert("Error...");
                    console.log(response);
                });
        }

        function getGamesByPublisher(publisher) {
            var d = "";
            service("getByPublisher", "{p:" + "\'" + publisher + "\'" + "}",
                function (response) {
                    $.each(response, function (index, value) {
                        cleansedTitle = value.gameName.replace(/ /g, "_").replace(/:/g, "").replace(/#/g, "").replace(/'/g, "");
                        d += "<tr>" +
                            "<td id=\"gameName\">" + value.gameName + "</td>" +
                            "<td>" + value.consoleName + "</td>" +
                            "<td>" + value.genreName + "</td>" +
                            "<td>" + value.publisher + "</td>" +
                            "<td id=\"btn" + cleansedTitle + "Pop\">" + value.popularity + "</td>" +
                            "<td><button id=\"btn" + cleansedTitle + "\" onClick=\"vote(\'" + value.gameName.replace(/'/g, "\\'") + "\', \'" + cleansedTitle + "\')\">I want to play this.</button>" + "</td>" +
                            "<td><button id=\"btn" + cleansedTitle + "\" onClick=\"rentalForm(\'" + value.gameName.replace(/'/g, "\\'") + "\')\">Rent</button>" + "</td>" +
                            "</tr>";
                    });
                    $("#gameList").html(d);
                }, function (response) {
                    alert("Error...");
                    console.log(response);
                });
        }

        function getGamesByPopularity(popularity) {
            var d = "";
            service("getByPopularity", "{p:" + "\'" + popularity + "\'" + "}",
                function (response) {
                    $.each(response, function (index, value) {
                        cleansedTitle = value.gameName.replace(/ /g, "_").replace(/:/g, "").replace(/#/g, "").replace(/'/g, "");
                        d += "<tr>" +
                            "<td id=\"gameName\">" + value.gameName + "</td>" +
                            "<td>" + value.consoleName + "</td>" +
                            "<td>" + value.genreName + "</td>" +
                            "<td>" + value.publisher + "</td>" +
                            "<td id=\"btn" + cleansedTitle + "Pop\">" + value.popularity + "</td>" +
                            "<td><button id=\"btn" + cleansedTitle + "\" onClick=\"vote(\'" + value.gameName.replace(/'/g, "\\'") + "\', \'" + cleansedTitle + "\')\">I want to play this.</button>" + "</td>" +
                            "<td><button id=\"btn" + cleansedTitle + "\" onClick=\"rentalForm(\'" + value.gameName.replace(/'/g, "\\'") + "\')\">Rent</button>" + "</td>" +
                            "</tr>";
                    });
                    $("#gameList").html(d);
                }, function (response) {
                    alert("Error...");
                    console.log(response);
                });
        }

        function vote(gameTitle, gameTitleCleansed) {
            var newPop;

            service("vote", "{gameName:" + "\'" + gameTitle.replace(/'/g, "\\'") + "\'" + "}", // {gameName: '\'n Verlore Verstand'}
                function (response) {
                    // Popularity should have updated. Now get the new table values.
                    $.each(response, function (index, value) {
                        newPop = value.popularity;
                    });
                    // Render the change to the table
                    $("#btn" + gameTitleCleansed + "Pop").html("" + newPop);
                }, function (response) {
                    alert("Error...");
                    console.log(response);
                }
            );
    }

        function rentalForm(gameTitle) {
            //var newPop;
            $("#rent").html("<form>Renter: <input type=\"text\" id=\"renter\"><br><form>Approving Officer: <input type=\"text\" id=\"officer\"><br></form><button id=\"btnRent\" onClick=\"rent(\'" + gameTitle.replace(/'/g, "\\'") + "\')\">Submit</button>");


            
            //    function (response) {
            //        // Popularity should have updated. Now get the new table values.
            //        $.each(response, function (index, value) {
            //            newPop = value.popularity;
            //        });
            //        // Render the change to the table
            //        $("#btn" + gameTitleCleansed + "Pop").html("" + newPop);
            //    }, function (response) {
            //        alert("Error...");
            //        console.log(response);
            //    }
            //);
        }
    function rent(gameTitle) {
            service("rent", "{gameName:" + "\'" + gameTitle.replace(/'/g, "\\'") + "\', renterId: \'" + document.getElementById('renter').value + "\', officerId: \'" + document.getElementById('officer').value + "\'} ", function () { }); // {gameName: '\'n Verlore Verstand'}
        }
        ////function rent(gameTitle) {
        //    service("rent", "{gameName:\'3D MiniGolf\', renterId: \'124867\', officerId: \'124867\'} ", function () { }); // {gameName: '\'n Verlore Verstand'}
        //}   
    </script>
</body>
</html>


